---
import BaseLayout from "../layouts/BaseLayout.astro";
import authClient from "../lib/apiClient.jsx";

// Define custom colors if not already in your tailwind.config.cjs
const primaryBlue = '#004AAD';
const accentCyan = '#00C2CB';
const textDark = '#212529';
---

<BaseLayout title="Нууц үг сэргээх" description="Нууц үг сэргээх хуудас">
    <main class="container mx-auto px-4 py-16 flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white shadow-xl rounded-xl p-8 sm:p-10 w-full max-w-md border border-gray-200 animate-fade-in">
            <h1 class="text-3xl font-extrabold text-center text-primaryBlue mb-6 tracking-tight">
                Нууц үг сэргээх
            </h1>
            <p class="text-center text-gray-600 mb-8">
                Бүртгэлтэй имэйл хаягаа оруулна уу. Бид танд нууц үг сэргээх холбоос илгээнэ.
            </p>

            <form id="forgot-password-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-semibold text-textDark mb-2">Имэйл хаяг</label>
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        autocomplete="email"
                        placeholder="Таны имэйл хаяг"
                        class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primaryBlue focus:border-primaryBlue outline-none transition duration-200 ease-in-out placeholder-gray-400"
                    />
                </div>

                <button
                    type="submit"
                    id="reset-password-button"
                    class="w-full bg-primaryBlue text-white font-bold py-3 px-4 rounded-lg hover:bg-accentCyan focus:outline-none focus:ring-2 focus:ring-primaryBlue focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105"
                >
                    Нууц үг сэргээх холбоос илгээх
                </button>

                <p id="forgot-password-message" class="text-center text-sm mt-4" role="status" aria-live="polite"></p>

                <p class="text-center text-sm text-gray-600 mt-6">
                    <a href="/login" class="font-medium text-primaryBlue hover:text-accentCyan transition duration-200 ease-in-out hover:underline">
                        Нэвтрэх хуудас руу буцах
                    </a>
                </p>
            </form>
        </div>
    </main>

    <script is:inline>
        const primaryBlue = '#004AAD';
        const textDark = '#212529';

        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("forgot-password-form");
            const emailInput = document.getElementById("email");
            const messageElement = document.getElementById("forgot-password-message");
            const resetButton = document.getElementById("reset-password-button");

            if (!form || !emailInput || !messageElement || !resetButton) {
                console.error("One or more required elements for forgot password not found.");
                return;
            }

            form.addEventListener("submit", async function (event) {
                event.preventDefault();

                const email = emailInput.value.trim();

                messageElement.textContent = "";
                messageElement.style.color = textDark;
                resetButton.disabled = true;
                resetButton.textContent = "Илгээж байна...";
                resetButton.classList.add("opacity-75", "cursor-not-allowed");

                try {
                    const response = await authClient.post("/api/forgot-password", { email });

                    if (response.status >= 200 && response.status < 300) {
                        messageElement.textContent = "✅ Нууц үг сэргээх холбоосыг таны имэйл хаяг руу илгээлээ.";
                        messageElement.style.color = "green";
                        form.reset(); // Clear the email field
                    } else {
                        messageElement.textContent = `❌ Алдаа: ${response.statusText || 'Имэйл илгээхэд алдаа гарлаа.'}`;
                        messageElement.style.color = "red";
                    }
                } catch (error) {
                    console.error("Forgot password request failed:", error);
                    const message = error?.response?.data?.message || 'Сервертэй холбогдоход алдаа гарлаа. Дахин оролдоно уу.';
                    messageElement.textContent = `❌ ${message}`;
                    messageElement.style.color = "red";
                } finally {
                    resetButton.disabled = false;
                    resetButton.textContent = "Нууц үг сэргээх холбоос илгээх";
                    resetButton.classList.remove("opacity-75", "cursor-not-allowed");
                }
            });
        });
    </script>

    <style is:global>
        /* Re-use fade-in animation from login page if not already global */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
    </style>
</BaseLayout>