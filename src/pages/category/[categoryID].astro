---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CategoryId from '../../components/CategoryId.jsx';
import apiClient from '../../api/apiClient.jsx';

export async function getStaticPaths() {
  const data = await apiClient.categories.getAll();
  const categories = Array.isArray(data) ? data : [];
  return categories.map((c) => ({
    params: { categoryID: String(c.id) },
    props: { categoryTitle: c.name },
  }));
}

const { categoryID } = Astro.params;
const { categoryTitle } = Astro.props;

// Fetch categories for sidebar
let sidebarCategories = [];
try {
  const data = await apiClient.categories.getAll();
  sidebarCategories = Array.isArray(data) ? data : [];
} catch (e) {
  sidebarCategories = [];
}
---

<BaseLayout title={categoryTitle}>
  <main class="max-w-7xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      
      <!-- Sidebar (Desktop) -->
      <aside class="hidden lg:block lg:col-span-3">
        <div class="bg-white rounded shadow p-4 h-[80vh] overflow-y-auto">
          <h3 class="font-semibold mb-2">Ангилалууд</h3>
          <div class="flex flex-col gap-1">
            {sidebarCategories.map((cat) => (
              <a
                href={`/category/${cat.id}`}
                class={`block px-3 py-2 rounded transition ${
                  String(cat.id) === categoryID
                    ? "bg-[#f7941e] text-white"
                    : "hover:bg-gray-100"
                }`}
              >
                {cat.name}
              </a>
            ))}
          </div>
        </div>
      </aside>

      <!-- Mobile dropdown for categories -->
      <div class="lg:hidden mb-4">
        <select
          class="w-full border rounded px-3 py-2"
          onchange="window.location.href=this.value"
        >
          {sidebarCategories.map((cat) => (
            <option
              value={`/category/${cat.id}`}
              selected={String(cat.id) === categoryID}
            >
              {cat.name}
            </option>
          ))}
        </select>
      </div>

      <!-- Category Products -->
      <section class="lg:col-span-9">
        <CategoryId
          categoryId={categoryID}
          categoryTitle={categoryTitle}
          client:load
        />
      </section>
    </div>
  </main>
</BaseLayout>
