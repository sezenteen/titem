---
import BaseLayout from "../layouts/BaseLayout.astro";
import ProductCard from "../components/ProductCard.astro";

const PAGE_SIZE = 20; // products per page
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') ?? '1', 10); // frontend 1-indexed

let products = [];
let totalProducts = 0;
let totalPages = 0;
let error = null;

// Fetch paginated products from backend
try {
    const response = await fetch(`http://localhost:8080/api/product?page=${page - 1}&size=${PAGE_SIZE}`);
    if (!response.ok) throw new Error(`HTTP алдаа! статус: ${response.status}`);

    const data = await response.json();
    products = data.content || [];
    totalProducts = data.totalElements || 0;
    totalPages = data.totalPages || 0;
} catch (err) {
    console.error("Бүтээгдэхүүнийг татаж чадсангүй:", err);
    error = "Бүтээгдэхүүнүүдийг татаж чадсангүй. Таны сүлжээ эсвэл серверт асуудал байна.";
}

// Separate a few products for the horizontal scroll section
const scrollingProducts = products.slice(0, 8);

function getPageUrl(p) {
    return `/?page=${p}`;
}

// Create pagination range with ellipsis
const pageRange = 2;
const pages = [];
if (totalPages > 1) {
    if (page > pageRange + 1) {
        pages.push(1);
        pages.push("...");
    }
    for (let i = Math.max(1, page - pageRange); i <= Math.min(totalPages, page + pageRange); i++) {
        pages.push(i);
    }
    if (page < totalPages - pageRange) {
        if (page < totalPages - pageRange - 1) {
            pages.push("...");
        }
        pages.push(totalPages);
    }
}
---

<BaseLayout title="Нүүр хуудас">
    <div class="px-[3%] py-3 2xl:px-[8%]">

        <!-- Main Carousel Section -->
        <!-- ... your carousel code stays unchanged ... -->

        <!-- Featured/Gift Items Horizontal Scroll Section -->
        <div class="max-w-6xl mx-auto mt-8">
            <h2 class="text-2xl font-bold mb-4">Бэлэг дурсгал (Gift Items)</h2>
            <div x-data="{ scrollLeft() { this.$refs.slider.scrollBy({ left: -300, behavior: 'smooth' }); }, scrollRight() { this.$refs.slider.scrollBy({ left: 300, behavior: 'smooth' }); } }" class="relative">
                <button @click="scrollLeft" class="absolute left-0 top-1/2 -translate-y-1/2 bg-white shadow-lg p-2 rounded-full z-10 hidden md:block hover:scale-105 transition-transform duration-200" aria-label="Scroll left">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div x-ref="slider" class="flex overflow-x-auto space-x-4 p-4 scrollbar-hide snap-x snap-mandatory">
                    {scrollingProducts.map((product: any) => (
                        <a href={`/product/${product.id}`} class="flex-shrink-0 w-64 snap-start hover:shadow-lg transition-shadow duration-200 rounded-lg overflow-hidden bg-white">
                            <img src={product.imagePath} class="w-full h-40 object-cover" alt={product.name} />
                            <div class="p-3">
                                <h4 class="font-semibold text-sm">{product.name}</h4>
                                <p class="text-gray-600 text-xs">{product.category}</p>
                            </div>
                        </a>
                    ))}
                </div>
                <button @click="scrollRight" class="absolute right-0 top-1/2 -translate-y-1/2 bg-white shadow-lg p-2 rounded-full z-10 hidden md:block hover:scale-105 transition-transform duration-200" aria-label="Scroll right">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </div>

        <!-- Main Product Grid Section -->
        <div class="bg-gray-100 p-6 max-w-6xl mx-auto mt-8 rounded-lg shadow-inner">
            <h2 class="text-2xl font-semibold text-center mb-6">Шинэ бүтээгдэхүүнүүд</h2>
            
            {error ? (
                <div class="text-center py-12">
                    <p class="text-xl text-red-600">{error}</p>
                </div>
            ) : products.length > 0 ? (
                <>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                        {products.map((product: any) => (
                            <ProductCard product={product} />
                        ))}
                    </div>

                    {totalPages > 1 && (
                        <div class="flex justify-center mt-8 space-x-2">
                            {page > 1 && (
                                <a href={getPageUrl(page - 1)} class="px-3 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300">
                                    Өмнөх
                                </a>
                            )}
                            {pages.map(p => (
                                p === "..." ? (
                                    <span class="px-3 py-1 text-gray-500">...</span>
                                ) : (
                                    <a href={getPageUrl(p)} class={`px-3 py-1 rounded ${page === p ? 'bg-[#f7941e] text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>
                                        {p}
                                    </a>
                                )
                            ))}
                            {page < totalPages && (
                                <a href={getPageUrl(page + 1)} class="px-3 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300">
                                    Дараах
                                </a>
                            )}
                        </div>
                    )}
                </>
            ) : (
                <div class="text-center py-12">
                    <p class="text-xl text-gray-600">Одоогоор бүтээгдэхүүн байхгүй байна.</p>
                    <p class="text-gray-500 mt-2">Дараарай дахин шалгана уу.</p>
                </div>
            )}
        </div>
    </div>
</BaseLayout>

<style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .snap-x { scroll-snap-type: x mandatory; }
    .snap-start { scroll-snap-align: start; }
</style>
