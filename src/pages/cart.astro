---
import BaseLayout from '../layouts/BaseLayout.astro';
import apiClient from '../api/apiClient.jsx';
import { useState } from "react";

// --- fetching logic stays the same ---
const { id } = Astro.params;
let product = null;
let error = null;

try {
  product = await apiClient.products.getById(id);
} catch (e) {
  console.error(`Error fetching product with ID ${id}:`, e);
  error = "–ë“Ø—Ç—ç—ç–≥–¥—ç—Ö“Ø“Ø–Ω–∏–π–≥ —Ç–∞—Ç–∞–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π.";
}

const formattedPrice = new Intl.NumberFormat('mn-MN').format(product?.price || 0);
---

<BaseLayout title={product ? product.name : "–ë“Ø—Ç—ç—ç–≥–¥—ç—Ö“Ø“Ø–Ω"}>
  <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <a href="/" class="text-sm text-[#003375] hover:text-[#f7941e] font-medium mb-6 inline-block">
      ‚Üê –ù“Ø“Ø—Ä —Ö—É—É–¥–∞—Å —Ä—É—É –±—É—Ü–∞—Ö
    </a>

    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <strong class="font-bold">–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞!</strong>
        <span class="block sm:inline ml-2">{error}</span>
      </div>
    )}

    {product && (
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden md:flex">
        <div class="md:w-1/2 p-4 flex items-center justify-center">
          <img
            src={product.imagePath || "https://placehold.co/600x600/E0E0E0/ffffff?text=–ó—É—Ä–∞–≥+–±–∞–π—Ö–≥“Ø–π"}
            alt={product.name}
            class="rounded-xl object-contain max-h-96 w-full"
          />
        </div>
        <div class="md:w-1/2 p-8">
          <h1 class="text-3xl font-extrabold text-[#003375] mb-2">{product.name}</h1>
          <p class="text-xl font-semibold text-gray-800 mb-4">{formattedPrice} ‚ÇÆ</p>
          <p class="text-gray-600 mb-6">{product.shortName}</p>

          <!-- Add to Cart Button -->
          <button
            class="w-full bg-[#003375] text-white font-semibold py-3 rounded-xl hover:bg-[#f7941e] transition"
            onClick={async () => {
              try {
                let cartId = localStorage.getItem("cartId");
                if (!cartId) {
                  // Create new cart
                  const cart = await apiClient.carts.create();
                  cartId = cart.id;
                  localStorage.setItem("cartId", cartId);
                }

                await apiClient.carts.addProduct(cartId, product.id, 1);
                alert("–°–∞–≥—Å–∞–Ω–¥ –Ω—ç–º—ç–≥–¥–ª—ç—ç!");
              } catch (err) {
                console.error("Cart error:", err);
                alert("–°–∞–≥—Å–∞–Ω–¥ –Ω—ç–º—ç—Ö—ç–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞.");
              }
            }}
          >
            üõí –°–∞–≥—Å–∞–Ω–¥ –Ω—ç–º—ç—Ö
          </button>

          <div class="border-t border-gray-200 pt-6 mt-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π –º—ç–¥—ç—ç–ª—ç–ª</h2>
            <ul class="text-gray-700 space-y-2">
              <li class="flex justify-between"><span class="font-medium">–ë–∞—Ä–∫–æ–¥:</span> <span>{product.barcode}</span></li>
              <li class="flex justify-between"><span class="font-medium">–ê–Ω–≥–∏–ª–∞–ª:</span> <span>{product.categoryID?.name || "–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π"}</span></li>
              <li class="flex justify-between"><span class="font-medium">–•—ç–º–∂–∏—Ö –Ω—ç–≥–∂:</span> <span>{product.measureUnitID?.name || "–¢–æ–¥–æ—Ä—Ö–æ–π–≥“Ø–π"}</span></li>
              <li class="flex justify-between"><span class="font-medium">–ù”®–ê–¢-–≥“Ø–π —ç—Å—ç—Ö:</span> <span>{product.isVATFree ? "–¢–∏–π–º" : "“Æ–≥“Ø–π"}</span></li>
            </ul>
          </div>
        </div>
      </div>
    )}
  </section>
</BaseLayout>
